name: Build Cosmic IDE

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # Required to create issues

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git commit info
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
      
      - name: Build Dev Debug APK
        run: ./gradlew assembleDevDebug --stacktrace
      
      - name: Build Prod Debug APK
        run: ./gradlew assembleProdDebug --stacktrace
      
      - name: Upload Dev Debug APKs
        uses: actions/upload-artifact@v4
        with:
          name: dev-debug-apks
          path: app/build/outputs/apk/dev/debug/*.apk
          if-no-files-found: error
      
      - name: Upload Prod Debug APKs
        uses: actions/upload-artifact@v4
        with:
          name: prod-debug-apks
          path: app/build/outputs/apk/prod/debug/*.apk
          if-no-files-found: error
          
      - name: Build Dev Release APK
        run: ./gradlew assembleDevRelease --stacktrace
      
      - name: Build Prod Release APK
        run: ./gradlew assembleProdRelease --stacktrace
      
      - name: Upload Dev Release APKs
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-apks
          path: app/build/outputs/apk/dev/release/*.apk
          if-no-files-found: error
      
      - name: Upload Prod Release APKs
        uses: actions/upload-artifact@v4
        with:
          name: prod-release-apks
          path: app/build/outputs/apk/prod/release/*.apk
          if-no-files-found: error

  # Job that runs only when build fails
  create-failure-issue:
    runs-on: ubuntu-latest
    needs: build
    if: failure()  # Only run if the build job failed
    
    steps:
      - name: Create failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the workflow run details
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          
          # Create issue with detailed information
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "üö® Build Failed: Cosmic IDE - Run #${{ github.run_number }}" \
            --label "bug,build-failure,automated" \
            --assignee "Undertaker-afk" \
            --body "## Build Failure Report
          
          The Cosmic IDE build workflow has failed. Please investigate and fix the issue.
          
          ### üìã Failure Details
          - **Workflow Run**: [#${{ github.run_number }}](${WORKFLOW_URL})
          - **Branch**: \`${BRANCH}\`
          - **Commit**: [\`${COMMIT_SHA:0:7}\`](${COMMIT_URL})
          - **Triggered by**: @${ACTOR}
          - **Event**: \`${{ github.event_name }}\`
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ü§ñ AI Assistant Prompt
          
          @coderabbitai @cto @copilot Please analyze the workflow failure at ${WORKFLOW_URL} and help diagnose the build issue.
          
          **Context for AI analysis:**
          1. Review the workflow logs to identify the failing step
          2. Check for Gradle build errors, dependency issues, or SDK problems
          3. Examine recent commits that might have introduced the failure
          4. Suggest specific fixes with code changes if applicable
          5. Verify if this is a transient issue or requires code changes
          
          ### üîç Investigation Steps
          1. Click the workflow run link above to view full logs
          2. Identify which build variant failed (Dev/Prod, Debug/Release)
          3. Check the stacktrace for error details
          4. Review recent code changes
          5. Apply suggested fixes
          
          ### üõ†Ô∏è Quick Fixes to Try
          - Update dependencies if outdated
          - Sync Gradle files
          - Check for SDK version compatibility
          - Verify signing configurations
          - Review recent commits for breaking changes
          
          ---
          *This issue was automatically created by the Build workflow. Close this issue once the build is fixed.*"
